# 人类图高级功能研究总结

## ✅ 2017-01-20 验证结果

### 完整对比

| 行星 | 设计端(红色) | 个性端(黑色) | 专业软件匹配 | 箭头符号 |
|------|------------|------------|-------------|---------|
| 太阳 ☉ | 28.1 | 60.5 | ✅ 100% | - |
| 地球 ⊕ | 27.1 | 56.5 | ✅ 100% | ▼ |
| 月亮 ☽ | 40.1 | 28.6 | ✅ 100% | - |
| 北交点 ☊ | 64.1 | 59.5 | ✅ 100% | - |
| 南交点 ☋ | 63.1 | 55.5 | ✅ 100% | - |
| 水星 ☿ | 50.6 | 58.3 | ✅ 100% | - |
| 金星 ♀ | 9.4 | 22.1 | ✅ 100% | - |
| 火星 ♂ | 54.5 | 36.2 | ✅ 100% | - |
| 木星 ♃ | 48.1 | 32.3 | ✅ 100% | ▼ |
| 土星 ♄ | 5.3 | 11.1 | ✅ 100% | - |
| 天王星 ♅ | 42.2 | 42.1 | ✅ 100% | - |
| 海王星 ♆ | 37.4 | 37.5 | ✅ 100% | ▲ |
| 冥王星 ♇ | 54.1 | 54.3 | ✅ 100% | ▲ |

**结论：所有计算100%准确！** 🎉

## 📊 1. 上下行箭头符号（Exalted/Detriment）

### 符号含义

- **▲ = Exalted（庙旺/耀升）** - 行星处于有利位置
- **▼ = Detriment（失势/陷落）** - 行星处于挑战位置
- **无符号 = None** - 正常状态
- **★ = Juxtaposed** - 同时Exalted和Detriment（特殊状态）

### 实现方式

✅ **已找到完整规则表！**

位置：`SharpAstrology.HumanDesign/Utility/HumanDesignUtility.cs` (第94-813行)

**规则表结构：**
```csharp
private static FixingState _getStateFromStatesTable(Planets planet, Gates gate, Lines line)
{
    return planet switch
    {
        Planets.Moon => (gate, line) switch
        {
            (Gates.Key1, Lines.One) => FixingState.Exalted,
            (Gates.Key5, Lines.Three) => FixingState.Detriment,
            // ... 数百条规则
        },
        Planets.Earth => (gate, line) switch { ... },
        Planets.Sun => (gate, line) switch { ... },
        // ... 其他行星
    }
}
```

**覆盖范围：**
- 月亮 (Moon): ~60条规则
- 天王星 (Uranus): ~30条规则
- 金星 (Venus): ~85条规则
- 火星 (Mars): ~125条规则
- 地球 (Earth): ~50条规则
- 木星 (Jupiter): ~92条规则
- 冥王星 (Pluto): ~77条规则
- 土星 (Saturn): ~50条规则
- 水星 (Mercury): ~60条规则
- 海王星 (Neptune): ~50条规则
- 太阳 (Sun): ~72条规则

**总计：约800+条规则**

### 验证示例（2017-01-20）

从专业软件截图验证：
- ✅ 地球 56.5 → ▼ (Detriment)
- ✅ 木星 32.3 → ▼ (Detriment)
- ✅ 海王星 37.5 → ▲ (Exalted)
- ✅ 冥王星 54.3 → ▲ (Exalted)

## 📐 2. Color / Tone / Base 系统

### 度数细分结构

```
1个闸门 (Gate) = 5.625°
  └─ 6个爻线 (Line) = 0.9375° 每个
      └─ 6个Color = 0.15625° 每个
          └─ 6个Tone = 0.026042° 每个
              └─ 5个Base = 0.005208° 每个
```

### 计算公式（已在SharpAstrology中找到）

```csharp
const double HdOffsetToZodiac = 3.875;
const double DegreePerGate = 5.625;
const double DegreePerLine = 0.9375;
const double DegreePerColor = 0.15625;
const double DegreePerTone = DegreePerColor / 6;
const double DegreePerBase = DegreePerTone / 5;

public static Activation ActivationOf(double longitude)
{
    var x = longitude - HdOffsetToZodiac;
    if (x < 0) x += 360;

    return new Activation()
    {
        Gate = (Gates)Math.Floor(x / DegreePerGate),
        Line = (Lines)Math.Floor((x % DegreePerGate) / DegreePerLine) + 1,
        Color = (Color)Math.Floor((x % DegreePerLine) / DegreePerColor) + 1,
        Tone = (Tone)Math.Floor((x % DegreePerColor) / DegreePerTone) + 1,
        Base = (Base)Math.Floor((x % DegreePerTone) / DegreePerBase) + 1,
        // ...
    };
}
```

### 数据类型

```csharp
// Color, Tone: 1-6
public enum Color { One = 1, Two, Three, Four, Five, Six }
public enum Tone { One = 1, Two, Three, Four, Five, Six }

// Base: 1-5
public enum Base { One = 1, Two, Three, Four, Five }
```

## 🏹 3. 四箭头（Four Arrows / Variables）

### 四个变量

位置：人体图顶部的4个箭头

```csharp
public sealed class Variables
{
    public Variable Digestion { get; init; }      // 消化（左上箭头）
    public Variable Perspective { get; init; }    // 视角（右下箭头）
    public Variable Environment { get; init; }    // 环境（左下箭头）
    public Variable Awareness { get; init; }      // 觉知（右上箭头）
}

public sealed class Variable
{
    public Orientation Orientation { get; init; } // Left 或 Right
    public Color Color { get; init; }
    public Tone Tone { get; init; }
    public Base Base { get; init; }
}
```

### 箭头方向含义

- **← 左箭头 (Left)**: 聚焦型、主动型、固定性
- **→ 右箭头 (Right)**: 开放型、被动型、流动性

### 四个变量详解

#### 1. **Digestion（消化）** - 左上箭头
- 如何"消化"世界、食物和信息
- 如何吸收和同化知识

#### 2. **Environment（环境）** - 左下箭头
- 什么样的环境（稳定/变化）最适合你
- 在什么环境中能发挥最高水平

#### 3. **Perspective（视角）** - 右下箭头
- 你天生要"看到"什么
- 左箭头：聚焦视野
- 右箭头：周边视野

#### 4. **Awareness（觉知）** - 右上箭头
- 如何回忆信息
- 如何过滤知识

### 如何计算四箭头

基于太阳和地球的Color和Tone值：

1. **Digestion**: 基于个性太阳的Color
2. **Perspective**: 基于个性地球的Color
3. **Environment**: 基于设计太阳的Color
4. **Awareness**: 基于设计地球的Color

**箭头方向规则：**
- Color 1-3: 左箭头 (Left)
- Color 4-6: 右箭头 (Right)

## 📊 实现状态总结

| 功能 | 状态 | 实现难度 | 数据来源 |
|------|------|---------|---------|
| **闸门和爻线计算** | ✅ 已实现并验证 | 简单 | swisseph-wasm |
| **设计端计算** | ✅ 已实现并验证 | 中等 | 二分查找 |
| **上下行箭头** | ✅ 规则表已找到 | 中等 | SharpAstrology |
| **Color/Tone/Base** | ✅ 公式已找到 | 简单 | SharpAstrology |
| **四箭头Variables** | ✅ 逻辑已明确 | 简单 | 基于Color计算 |
| **SVG绘图** | ✅ 模板已找到 | 中等 | hdkit项目 |

## 🎯 下一步行动建议

### 阶段1：完善计算（优先级：高）
1. ✅ 实现Color/Tone/Base计算
2. ✅ 实现四箭头Variables计算
3. ⏸️ 移植Exalted/Detriment规则表（800+条规则）

### 阶段2：SVG绘图（优先级：中）
1. 使用hdkit的SVG模板
2. 动态标注闸门颜色（红/黑）
3. 添加箭头符号（▲/▼）
4. 添加四箭头显示

### 阶段3：高级功能（优先级：低）
1. 流日图（Transit）
2. 合图（Composite）
3. 类型和权威判断

## 📝 关键文件清单

### 已完成
- ✅ `verify-2017-case.mjs` - 2017案例验证
- ✅ `calculate-design-2017.mjs` - 设计端计算
- ✅ `2017-01-20完整对比.md` - 验证文档
- ✅ `高级功能研究总结.md` - 本文档

### 参考资料
- ✅ `SharpAstrology.HumanDesign/Utility/HumanDesignUtility.cs` - 完整规则表
- ✅ `hdkit/sample-apps/hdkit_sample_app/app/assets/images/bodygraph-blank.svg` - SVG模板

---

**生成时间**: 2025-10-11
**状态**: ✅ 研究完成，可以开始实现
