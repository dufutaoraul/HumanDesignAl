/**
 * FixingState完整规则表
 *
 * 数据来源：SharpAstrology.HumanDesign/Utility/HumanDesignUtility.cs Line 94-707
 *
 * 规则表定义：行星 + 闸门 + 爻线 → FixingState
 *
 * FixingState枚举：
 * - None = 0 (无箭头)
 * - Exalted = 1 (▲ 上升/庙旺)
 * - Detriment = 2 (▼ 下降/失势)
 * - Juxtaposed = 3 (✲ 并列 = Exalted | Detriment)
 */

const FixingState = {
  None: 0,
  Exalted: 1,        // ▲
  Detriment: 2,      // ▼
  Juxtaposed: 3      // ✲
};

const Planet = {
  Sun: 'Sun',
  Earth: 'Earth',
  Moon: 'Moon',
  NorthNode: 'NorthNode',
  SouthNode: 'SouthNode',
  Mercury: 'Mercury',
  Venus: 'Venus',
  Mars: 'Mars',
  Jupiter: 'Jupiter',
  Saturn: 'Saturn',
  Uranus: 'Uranus',
  Neptune: 'Neptune',
  Pluto: 'Pluto'
};

/**
 * 创建规则对象的辅助函数
 * @param {Array} rules - 规则数组 [[gate, line, state], ...]
 * @returns {Object} 规则对象 {'gate-line': state}
 */
function createRules(rules) {
  const result = {};
  rules.forEach(([gate, line, state]) => {
    result[`${gate}-${line}`] = state;
  });
  return result;
}

const E = FixingState.Exalted;
const D = FixingState.Detriment;

const fixingRules = {
  Moon: createRules([
    [1,1,E], [4,1,E], [4,2,E], [5,3,D], [6,5,D], [7,3,E], [8,3,E], [9,4,E], [9,6,E],
    [10,1,D], [10,3,D], [11,1,E], [11,4,E], [11,5,E], [13,1,D], [13,2,E], [14,4,E],
    [16,3,E], [16,5,D], [17,2,D], [17,6,E], [18,2,D], [18,6,D], [19,1,D], [19,3,D],
    [20,1,D], [20,2,D], [21,1,D], [22,1,E], [23,2,D], [23,5,D], [24,2,E], [24,5,E],
    [26,6,D], [27,2,E], [27,6,E], [30,6,D], [31,4,E], [31,5,D], [31,6,D], [32,5,E],
    [34,5,D], [35,2,D], [35,4,E], [36,2,D], [36,4,D], [37,4,E], [38,2,D], [39,2,E],
    [39,4,E], [39,6,E], [40,1,D], [40,2,D], [41,3,D], [42,3,D], [42,4,E], [42,6,E],
    [43,2,D], [43,3,D], [43,5,E], [46,3,E], [46,5,E], [47,4,D], [48,1,E], [48,3,E],
    [48,5,D], [48,6,D], [49,5,E], [50,3,E], [50,6,D], [53,2,E], [53,3,E], [53,4,E],
    [53,6,E], [55,6,D], [56,1,E], [56,2,D], [56,4,E], [57,1,D], [57,2,D], [57,5,D],
    [58,1,D], [58,5,E], [58,6,E], [61,2,E], [61,3,E], [62,5,E], [64,2,D], [64,3,D], [64,4,E]
  ]),

  Uranus: createRules([
    [1,1,D], [1,5,D], [2,3,D], [3,2,D], [5,4,E], [7,4,D], [7,6,D], [10,4,E], [17,5,E],
    [18,5,D], [20,5,D], [25,6,D], [40,4,E], [40,5,E], [44,5,E], [45,2,E], [45,5,E],
    [45,6,E], [51,4,E], [55,5,E], [56,2,E], [56,5,E], [57,6,E], [58,2,D], [58,3,E],
    [59,2,E], [59,5,D], [60,6,E], [62,3,E], [63,2,D]
  ]),

  Venus: createRules([
    [1,2,E], [2,1,E], [2,4,E], [3,3,E], [4,3,E], [5,2,E], [5,5,E], [6,2,E], [6,5,E],
    [6,6,D], [7,1,E], [7,5,E], [8,6,E], [11,3,D], [12,1,E], [13,1,E], [13,3,D], [13,4,D],
    [14,5,D], [15,1,E], [15,6,D], [17,1,D], [19,3,E], [19,4,D], [20,1,E], [20,2,E],
    [20,6,E], [21,6,D], [24,3,E], [25,4,E], [25,5,E], [26,5,D], [28,1,D], [29,2,D],
    [29,4,D], [32,2,E], [34,2,D], [35,1,E], [35,2,E], [37,1,E], [37,5,E], [37,6,E],
    [41,4,D], [41,5,D], [42,1,D], [42,2,D], [42,4,D], [42,5,D], [43,1,D], [43,5,D],
    [44,1,D], [47,5,E], [48,2,D], [48,6,E], [50,1,D], [50,2,D], [50,6,E], [51,1,D],
    [52,2,E], [52,3,D], [52,6,E], [53,1,D], [53,4,D], [54,1,D], [54,3,D], [55,1,D],
    [55,2,E], [56,3,D], [57,1,E], [57,2,E], [57,4,E], [58,1,E], [59,4,E], [59,6,E],
    [60,1,E], [60,4,D], [61,1,D], [62,3,D], [62,4,E], [64,1,E], [64,2,E], [64,5,E], [64,6,D]
  ]),

  Mars: createRules([
    [1,2,D], [1,3,E], [1,5,E], [2,1,D], [2,2,D], [2,4,D], [3,2,E], [3,4,D], [3,5,E],
    [4,2,D], [4,6,D], [5,1,E], [6,2,D], [9,1,D], [9,4,D], [10,2,D], [10,5,D], [11,1,D],
    [11,2,D], [12,3,D], [12,5,D], [13,6,E], [14,2,D], [14,4,D], [15,1,D], [16,3,D],
    [16,4,D], [17,1,E], [17,5,D], [18,6,E], [19,4,E], [19,6,D], [21,1,E], [21,2,E],
    [22,1,D], [22,3,D], [22,4,D], [22,5,D], [22,6,D], [23,1,D], [23,6,E], [24,2,D],
    [24,5,D], [25,2,D], [25,3,E], [26,1,D], [26,5,E], [27,2,D], [27,3,D], [27,4,D],
    [28,1,E], [29,1,E], [29,3,E], [29,6,E], [30,2,D], [30,6,E], [31,4,D], [32,1,D],
    [32,5,D], [33,1,D], [33,3,D], [34,2,E], [34,4,D], [34,5,E], [35,4,D], [35,6,D],
    [36,1,E], [37,3,D], [37,5,D], [38,1,D], [38,4,D], [39,1,E], [39,5,D], [39,6,D],
    [40,3,D], [40,4,D], [41,2,D], [41,5,E], [42,3,E], [43,6,D], [44,2,D], [44,3,E],
    [44,5,D], [45,1,D], [45,2,D], [45,3,D], [45,4,D], [46,2,D], [46,3,D], [47,3,D],
    [48,1,D], [48,5,E], [49,4,D], [49,5,D], [50,1,E], [50,4,D], [50,5,D], [51,2,E],
    [51,5,D], [52,1,D], [52,2,D], [53,2,D], [53,3,D], [54,2,D], [55,3,D], [55,4,D],
    [56,1,D], [56,5,D], [57,4,D], [57,6,D], [58,3,D], [59,3,D], [60,3,D], [61,2,D],
    [61,3,D], [61,5,D], [61,6,D], [62,1,D], [63,1,D], [63,4,D], [63,5,D], [64,1,D], [64,4,D]
  ]),

  Earth: createRules([
    [1,3,D], [1,4,E], [1,6,E], [2,5,D], [3,1,E], [3,5,D], [4,1,D], [5,1,D], [8,2,D],
    [9,3,E], [9,5,D], [10,3,E], [12,4,E], [12,6,D], [13,3,E], [14,3,E], [14,6,D],
    [15,2,D], [15,3,E], [16,1,E], [17,3,D], [18,1,E], [18,4,E], [19,5,E], [20,3,D],
    [21,4,D], [23,4,D], [25,6,E], [27,1,D], [29,5,D], [31,1,D], [34,6,E], [38,3,D],
    [38,6,D], [39,3,D], [40,5,D], [40,6,D], [41,4,E], [44,6,D], [46,4,E], [48,4,D],
    [49,2,E], [52,1,E], [52,5,E], [53,5,D], [55,2,D], [60,2,D]
  ]),

  Jupiter: createRules([
    [1,4,D], [2,3,E], [4,5,E], [8,4,E], [8,5,E], [9,2,D], [9,5,E], [10,5,E], [11,6,D],
    [12,1,D], [13,5,D], [14,1,E], [14,2,E], [15,4,E], [15,5,E], [16,4,E], [16,6,D],
    [17,4,D], [17,6,D], [18,1,D], [18,3,D], [19,2,E], [19,5,D], [19,6,E], [20,4,E],
    [21,3,D], [21,4,E], [21,5,E], [22,2,D], [22,5,E], [23,1,E], [23,2,E], [23,5,E],
    [23,6,D], [24,3,D], [24,6,E], [25,4,E], [25,5,D], [27,4,E], [27,5,E], [28,2,D],
    [28,3,D], [28,4,E], [29,3,D], [29,6,D], [30,1,D], [30,3,D], [30,4,D], [30,5,E],
    [31,2,E], [31,3,D], [32,2,D], [32,3,D], [32,4,E], [33,2,E], [33,3,E], [33,5,D],
    [33,6,D], [34,6,D], [35,3,E], [35,5,D], [36,1,D], [36,3,D], [36,6,E], [37,2,E],
    [37,3,E], [39,2,D], [39,3,E], [43,4,D], [44,2,E], [45,1,E], [45,4,E], [45,5,D],
    [45,6,D], [46,1,D], [47,3,E], [49,1,E], [49,4,E], [51,3,D], [52,4,D], [54,6,D],
    [55,1,E], [55,4,E], [60,5,D], [61,4,D], [63,2,E], [63,3,E], [63,6,E], [64,5,D]
  ]),

  Pluto: createRules([
    [1,6,D], [3,3,D], [3,6,D], [4,3,D], [4,5,D], [5,2,D], [5,5,D], [6,1,E], [6,3,D],
    [6,4,D], [8,6,D], [9,1,E], [9,2,E], [9,6,D], [10,6,E], [11,3,E], [13,4,E], [15,5,D],
    [15,6,E], [16,5,E], [17,3,E], [17,4,E], [18,2,E], [21,5,D], [21,6,E], [23,3,D],
    [24,6,D], [25,3,D], [26,2,D], [26,4,E], [27,3,E], [27,6,D], [28,5,E], [28,6,E],
    [30,3,E], [30,4,E], [30,5,D], [31,5,E], [32,6,E], [33,4,E], [33,5,E], [34,1,D],
    [34,4,E], [36,3,E], [36,4,E], [36,5,E], [38,2,E], [38,4,E], [38,5,D], [40,3,E],
    [41,6,D], [43,1,E], [43,2,E], [43,3,E], [44,1,E], [44,4,E], [44,6,E], [46,4,D],
    [48,2,E], [49,2,D], [49,3,D], [51,1,E], [51,6,D], [52,5,D], [53,6,D], [54,1,E],
    [54,3,E], [56,6,D], [57,5,E], [58,4,E], [59,2,D], [61,6,E], [62,4,D], [63,6,D]
  ]),

  Saturn: createRules([
    [2,2,E], [2,6,D], [4,4,D], [8,3,D], [10,6,D], [12,2,E], [15,4,D], [18,5,E], [20,5,E],
    [22,3,E], [24,4,E], [26,3,D], [26,4,D], [27,5,D], [28,3,E], [29,4,E], [32,4,D],
    [34,1,E], [34,3,E], [35,6,E], [36,6,D], [37,4,D], [38,5,E], [38,6,E], [41,2,E],
    [41,3,E], [41,6,E], [42,6,D], [46,6,E], [47,1,E], [47,2,E], [47,4,E], [49,6,D],
    [50,4,E], [50,5,E], [52,3,E], [52,4,E], [54,2,E], [54,6,E], [55,3,E], [55,6,E],
    [59,3,E], [60,2,E], [60,3,E], [61,4,E], [61,5,E], [62,2,E], [62,6,E], [63,3,D], [64,3,E]
  ]),

  Mercury: createRules([
    [2,5,E], [2,6,E], [3,1,D], [4,6,E], [6,1,D], [6,6,E], [7,1,D], [7,2,D], [7,3,D],
    [7,6,E], [8,1,D], [8,4,D], [10,2,E], [10,4,D], [11,5,D], [12,2,D], [12,4,D], [13,6,D],
    [14,1,D], [15,3,D], [16,1,D], [16,2,D], [18,4,D], [19,2,D], [20,4,D], [20,6,D],
    [25,1,D], [25,2,E], [28,4,D], [31,2,D], [32,3,E], [34,3,D], [35,5,E], [36,5,D],
    [37,2,D], [37,6,D], [39,1,D], [41,1,D], [43,4,E], [47,2,D], [48,3,D], [50,3,D],
    [51,2,D], [51,4,D], [56,4,D], [57,3,E], [58,6,D], [59,1,D], [59,4,D], [59,6,D],
    [60,1,D], [60,4,E], [60,6,D], [62,2,D], [62,6,D], [63,4,E], [64,6,E]
  ]),

  Neptune: createRules([
    [3,4,E], [5,3,E], [5,6,E], [6,3,E], [7,2,E], [7,5,D], [8,1,E], [11,2,E], [11,6,E],
    [12,3,E], [13,5,E], [14,3,D], [16,6,E], [18,3,E], [21,2,D], [21,3,E], [22,4,E],
    [24,1,D], [24,4,D], [25,1,E], [26,1,E], [28,6,D], [29,1,D], [32,6,D], [33,2,D],
    [33,4,D], [35,1,D], [36,2,E], [38,1,E], [39,5,E], [41,1,E], [44,3,D], [45,3,E],
    [46,1,E], [46,5,D], [46,6,D], [47,1,D], [49,3,E], [49,6,E], [52,6,D], [53,1,E],
    [53,5,E], [58,4,D], [60,5,E], [61,1,E], [62,1,E], [62,5,D]
  ]),

  Sun: createRules([
    [3,6,E], [4,4,E], [5,4,D], [6,4,E], [7,4,E], [8,2,E], [8,5,D], [9,3,D], [10,1,E],
    [11,4,D], [12,5,E], [12,6,E], [13,2,D], [14,5,E], [14,6,E], [15,2,E], [16,2,E],
    [17,2,E], [19,1,E], [20,3,E], [22,2,E], [22,6,E], [23,3,E], [23,4,E], [24,1,E],
    [26,2,E], [26,3,E], [26,6,E], [27,1,E], [28,2,E], [28,5,D], [29,2,E], [29,5,E],
    [30,1,E], [30,2,E], [31,1,E], [31,3,E], [31,6,E], [32,1,E], [33,1,E], [33,6,E],
    [35,3,D], [38,3,E], [39,4,D], [40,1,E], [40,2,E], [40,6,E], [42,1,E], [42,2,E],
    [42,5,E], [43,6,E], [44,4,D], [46,2,E], [47,6,D], [48,4,E], [49,1,D], [50,2,E],
    [51,3,E], [51,5,E], [51,6,E], [54,5,E], [55,5,D], [56,3,E], [56,6,E], [58,5,D],
    [59,1,E], [59,5,E], [63,1,E], [63,5,E]
  ])

  // 注意：NorthNode和SouthNode没有直接的规则表
  // 它们只能通过HarmonicGates聚合从其他行星获得箭头
};

/**
 * 查询FixingState规则
 * @param {string} planet - 行星名称
 * @param {number} gate - 闸门 (1-64)
 * @param {number} line - 爻线 (1-6)
 * @returns {number} FixingState值
 */
function getFixingState(planet, gate, line) {
  const planetRules = fixingRules[planet];
  if (!planetRules) {
    return FixingState.None;
  }

  const key = `${gate}-${line}`;
  return planetRules[key] || FixingState.None;
}

module.exports = {
  FixingState,
  Planet,
  fixingRules,
  getFixingState
};
