# 人类图计算差异分析总结

## 🔍 核心发现

### 1. 主要问题识别

对比专业软件输出，发现以下关键差异：

| 数据项 | 我的计算 | 专业软件 | 状态 |
|--------|---------|---------|------|
| 个性太阳 | 38.2 (280.81°) | 48.4 | ❌ 差10个闸门 |
| 个性海王星 | 38.3 (282.04°) | 38.1 | ✅ 基本正确 |
| 个性冥王星 | 1.5 (227.09°) | 1.1 | ✅ 基本正确 |
| 设计日期 | -88天 | 太阳-88度 | ❌ 方法错误 |

### 2. 已解决的问题

#### ✅ 设计日期计算方法
- ❌ 错误方法：出生日期 - 88天
- ✅ 正确方法：找到太阳退后88度的精确时刻（使用根查找算法）

```csharp
// SharpAstrology 的正确实现
RootFinder.FindRoot(jd => AngleDifference(
    SubtractDegree(sunsLongitude, 88),
    ephService.PlanetsPosition(Planets.Sun, jd).Longitude
), birthJD - 110, birthJD - 70)
```

#### ✅ 闸门映射逻辑理解
- Gates枚举的值（0-63）就是索引
- 枚举名称（Key17, Key48等）对应实际闸门号
- ToNumber()方法将枚举转换为闸门号（1-64）

### 3. 🚨 未解决的关键问题

#### ❓ Tropical vs Sidereal（回归黄道 vs 恒星黄道）

**问题描述**：
- 我的计算：太阳280.81° → 闸门38
- 专业软件：太阳 → 闸门48
- **差值约10个闸门** = 约56度！

**可能原因1：使用了不同的黄道系统**
- **Tropical（回归黄道）**: 以春分点为起点，随地球进动缓慢移动
- **Sidereal（恒星黄道）**: 以固定恒星为参照，不随地球移动
- 两者当前差异约 **24度**（Lahiri Ayanamsa）

但24度 ≠ 56度，所以可能不只是这个原因...

**可能原因2：不同的起始点偏移**
- HD_OFFSET = 3.875°
- 是否还有其他偏移量？
- 春分点 vs 其他参考点？

**可能原因3：计算模式错误**
- SharpAstrology支持两种模式：
  ```csharp
  public enum EphCalculationMode
  {
      Tropic = 0,    // 回归黄道
      Sidereal = 1   // 恒星黄道
  }
  ```

### 4. 🔬 需要验证的假设

#### 假设1：专业软件使用Sidereal模式
```javascript
// 需要测试
swisseph.set_sid_mode(swisseph.SE_SIDM_LAHIRI, 0, 0);
const position = swisseph.calc_ut(jd, swisseph.SE_SUN,
    swisseph.SEFLG_SWIEPH | swisseph.SEFLG_SIDEREAL);
```

#### 假设2：需要不同的偏移量
```javascript
// 可能需要调整
const HD_OFFSET = 3.875;  // 当前值
// 或者其他值？
```

#### 假设3：Earth位置计算方法不同
专业软件显示：
- 个性地球：21.4
- 我的计算：25.2

这不是简单的太阳对面（+180°）！

---

## 📋 下一步行动计划

### 优先级1：验证黄道系统
1. 测试Sidereal模式
2. 对比Tropical vs Sidereal的结果
3. 确认专业软件使用哪种模式

### 优先级2：研究Earth计算
1. 查看SharpAstrology如何计算Earth
2. 检查hdkit的Earth计算逻辑
3. 对比不同实现方式

### 优先级3：逆行行星
1. 研究行星逆行时的计算
2. 检查速度值（position[3]）的含义
3. 确认逆行是否影响闸门映射

---

## 💡 建议

### 短期方案
1. **找一个已知准确的人类图** 作为对照
   - 需要包含：出生日期、时间、地点
   - 以及该图的准确闸门数据
2. **用多个在线工具交叉验证** 同一个出生数据
3. **直接咨询人类图专家** 确认计算标准

### 长期方案
1. **完整复制SharpAstrology的逻辑**
   - 包括Sidereal模式支持
   - 包括所有细节参数
2. **建立自动化测试**
   - 多个已知案例
   - 自动对比结果

---

## 🎯 当前状态总结

### 已实现 ✅
- swisseph-wasm集成
- 基本的黄道→闸门映射
- 26个行星位置计算
- 闸门枚举逻辑理解

### 部分实现 ⚠️
- 设计日期计算（逻辑正确但未测试）
- Earth位置计算（可能有误）

### 待解决 ❌
- **Tropical vs Sidereal模式选择** ← 最关键
- **准确的闸门映射验证**
- **行星逆行处理**
- **与专业软件的精确对齐**

---

## 📚 参考资料

### SharpAstrology.HumanDesign 关键文件
- `Utility/HumanDesignUtility.cs:56-73` - ActivationOf()核心逻辑
- `ExtensionMethods/...cs:18-32` - DesignJulianDay()设计日期计算
- `Enums/Gates.cs` - 闸门枚举定义

### 关键常量
```csharp
private const double HdOffsetToZodiac = 3.875;
private const double DegreePerGate = 5.625;
private const double DegreePerLine = 0.9375;
```

### 根查找算法
使用Brent方法查找太阳退后88度的精确时刻，搜索范围：出生前70-110天

---

**最终建议**：建议先用您提供的专业软件数据，或找一个已知准确的案例，通过对比来确定正确的计算模式（Tropical/Sidereal）和所有参数。这样才能确保后续实现的准确性。
