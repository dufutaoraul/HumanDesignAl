# 人类图AI高我系统 - 完整需求文档

> **项目目标**：开发一个基于人类图理论的AI智能陪伴平台，用户可上传人类图图片，系统自动识别并推算，结合Dify知识库提供高我视角的智慧引导。

---

## 📋 一、技术架构

### 1.1 技术栈

```
前端：Next.js 14 + TypeScript + Tailwind CSS
数据库：Supabase（用户认证 + 数据存储）
AI对话：Dify Workflow API
图片识别：Gemini 2.0 Flash Vision API（免费额度：15 RPM, 1500次/天）
部署：Vercel
```

### 1.2 API配置

**Gemini API Key**:
```
AIzaSyD-5VGSanbUgrRRPH1R-gNXHekSdcLte3g
```

**使用限制**:
- 仅在用户录入/更新人类图档案时调用（节省额度）
- 主聊天功能不调用图片识别API
- 需实现调用频率控制和错误处理

### 1.3 用户认证系统（Supabase Auth）

**邮箱登录验证流程**：

```typescript
// 1. 用户注册流程
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
)

async function signUp(email: string, password: string) {
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: {
      emailRedirectTo: `${window.location.origin}/auth/callback`,
      data: {
        // 可选：额外的用户元数据
      }
    }
  })

  if (error) throw error

  // Supabase会自动发送验证邮件到用户邮箱
  // 用户点击邮件中的链接完成验证
  return data
}

// 2. 用户登录流程
async function signIn(email: string, password: string) {
  const { data, error } = await supabase.auth.signInWithPassword({
    email,
    password
  })

  if (error) throw error
  return data
}

// 3. 邮箱验证回调处理
// app/auth/callback/route.ts
import { NextResponse } from 'next/server'

export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const token_hash = searchParams.get('token_hash')
  const type = searchParams.get('type')

  if (token_hash && type) {
    const supabase = createClient()
    const { error } = await supabase.auth.verifyOtp({
      token_hash,
      type: type as any
    })

    if (!error) {
      // 验证成功，重定向到主页或档案设置页
      return NextResponse.redirect(new URL('/profile', request.url))
    }
  }

  // 验证失败，重定向到登录页
  return NextResponse.redirect(new URL('/login?error=verification_failed', request.url))
}

// 4. 检查用户登录状态
async function checkAuth() {
  const { data: { user } } = await supabase.auth.getUser()
  return user
}

// 5. 登出
async function signOut() {
  const { error } = await supabase.auth.signOut()
  if (error) throw error
}
```

**邮箱模板配置（Supabase Dashboard）**：

进入Supabase Dashboard → Authentication → Email Templates，自定义以下模板：

1. **Confirm signup**（注册验证邮件）
```html
<h2>欢迎来到人类图AI高我</h2>
<p>感谢注册！请点击下方按钮验证您的邮箱：</p>
<a href="{{ .ConfirmationURL }}">验证邮箱</a>
<p>如果您没有注册，请忽略此邮件。</p>
```

2. **Magic Link**（魔法链接登录，可选）
```html
<h2>登录人类图AI高我</h2>
<p>点击下方链接直接登录（有效期10分钟）：</p>
<a href="{{ .ConfirmationURL }}">立即登录</a>
```

3. **Reset Password**（重置密码）
```html
<h2>重置密码</h2>
<p>点击下方链接重置您的密码：</p>
<a href="{{ .ConfirmationURL }}">重置密码</a>
<p>如果您没有请求重置密码，请忽略此邮件。</p>
```

**登录页面设计要点**：
- 提供邮箱+密码注册/登录
- 可选：Google OAuth登录（需配置）
- 可选：Magic Link无密码登录
- 忘记密码功能
- 注册后提示用户检查邮箱验证
- 深蓝紫+金色主题，保持视觉一致

---

### 1.4 支付系统（zpay集成）

**zpay支付流程**：

```typescript
// lib/payment/zpay.ts

interface ZpayConfig {
  merchantId: string
  apiKey: string
  apiSecret: string
  webhookSecret: string
}

// 1. 创建支付订单
async function createPaymentOrder(
  userId: string,
  amount: number
) {
  const zpay = new ZpayClient({
    merchantId: process.env.ZPAY_MERCHANT_ID!,
    apiKey: process.env.ZPAY_API_KEY!,
    apiSecret: process.env.ZPAY_API_SECRET!
  })

  const order = await zpay.createOrder({
    out_trade_no: `HD_${Date.now()}_${userId}`, // 订单号
    subject: `人类图AI高我 - 年度订阅`,
    total_amount: amount, // 单位：分
    notify_url: `${process.env.NEXT_PUBLIC_APP_URL}/api/webhooks/zpay`,
    return_url: `${process.env.NEXT_PUBLIC_APP_URL}/payment/success`,
    extra: {
      user_id: userId
    }
  })

  return order
}

// 2. Webhook处理支付回调
// app/api/webhooks/zpay/route.ts
import { NextResponse } from 'next/server'

export async function POST(request: Request) {
  const body = await request.text()
  const signature = request.headers.get('x-zpay-signature')

  // 验证签名
  const isValid = verifyZpaySignature(body, signature, process.env.ZPAY_WEBHOOK_SECRET!)

  if (!isValid) {
    return NextResponse.json({ error: 'Invalid signature' }, { status: 401 })
  }

  const payload = JSON.parse(body)

  // 处理支付成功事件
  if (payload.event === 'payment.succeeded') {
    const { out_trade_no, extra, total_amount } = payload.data
    const { user_id } = extra

    // 更新用户订阅状态
    const supabase = createClient()
    const expiresAt = new Date()
    expiresAt.setFullYear(expiresAt.getFullYear() + 1) // 1年后过期

    await supabase
      .from('subscriptions')
      .upsert({
        user_id,
        status: 'active',
        expires_at: expiresAt,
        updated_at: new Date()
      }, {
        onConflict: 'user_id'
      })

    // 记录订单
    await supabase
      .from('orders')
      .insert({
        user_id,
        order_id: out_trade_no,
        amount: total_amount,
        status: 'paid',
        paid_at: new Date()
      })

    console.log(`Payment succeeded for user ${user_id}, amount: ${total_amount}`)
  }

  return NextResponse.json({ received: true })
}

// 3. 前端支付按钮
// components/PaymentButton.tsx
export function PaymentButton() {
  const [loading, setLoading] = useState(false)

  const handlePayment = async () => {
    setLoading(true)
    try {
      const response = await fetch('/api/payment/create', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })

      const { payment_url } = await response.json()

      // 跳转到zpay支付页面
      window.location.href = payment_url
    } catch (error) {
      console.error('Payment failed:', error)
      alert('支付失败，请重试')
    } finally {
      setLoading(false)
    }
  }

  return (
    <button
      onClick={handlePayment}
      disabled={loading}
      className="payment-btn"
    >
      {loading ? '跳转中...' : '¥99/年 立即开通'}
    </button>
  )
}
```

**数据库表补充**：

```sql
-- 订阅表
CREATE TABLE subscriptions (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id uuid REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  status text NOT NULL DEFAULT 'inactive', -- 'active', 'expired', 'cancelled'
  expires_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now()
);

-- 订单表
CREATE TABLE orders (
  id uuid PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id uuid REFERENCES auth.users(id),
  order_id text UNIQUE NOT NULL,
  amount integer NOT NULL, -- 单位：分
  status text NOT NULL, -- 'pending', 'paid', 'failed', 'refunded'
  paid_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now()
);

-- 索引
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
```

**权限检查中间件**：

```typescript
// lib/auth/checkSubscription.ts
export async function checkSubscription(userId: string): Promise<boolean> {
  const supabase = createClient()

  const { data, error } = await supabase
    .from('subscriptions')
    .select('status, expires_at')
    .eq('user_id', userId)
    .single()

  if (error || !data) {
    return false
  }

  // 检查订阅状态
  if (data.status !== 'active') {
    return false
  }

  // 检查是否过期
  if (data.expires_at) {
    const expiresAt = new Date(data.expires_at)
    if (expiresAt < new Date()) {
      // 订阅已过期，更新状态
      await supabase
        .from('subscriptions')
        .update({ status: 'expired' })
        .eq('user_id', userId)
      return false
    }
  }

  return true
}

// 在Dify API调用前检查权限
// app/api/chat/route.ts
export async function POST(request: Request) {
  const { userId, message } = await request.json()

  // 检查订阅状态
  const hasSubscription = await checkSubscription(userId)
  if (!hasSubscription) {
    return NextResponse.json(
      { error: '请先订阅服务' },
      { status: 403 }
    )
  }

  // 继续处理对话...
}
```

---

## 🎨 二、界面设计要求

### 2.1 整体风格

**主题色**：深蓝紫 + 金色（参考：`D:\工作盘\三个月陪跑\陪跑打卡模板\xiaohongshulinghangyuan`）

**配色方案**：
```css
--cosmic-blue: #1a1a2e
--nebula-purple: #16213e
--star-gold: #ffd700
--accent-blue: #0f3460
```

**视觉效果**：
- 毛玻璃质感（glassmorphism）
- 渐变文字
- 星空点缀动画
- 流畅过渡动画

❌ **避免**：粉色、紫色（非深蓝紫）

### 2.2 页面布局

#### 主聊天页面（`/chat`）

```
┌──────────────────────────────────────────────────┐
│  [Logo]  用户名 ▼  档案管理  [设置]           │  ← 顶部导航
├───────┬──────────────────────────────────────────┤
│       │                                          │
│ 会话1 │                                          │
│ 会话2 │         主聊天区域                        │
│ 会话3 │                                          │
│ 会话4 │                                          │
│       │                                          │
│ + 新  │  [输入框]                      [发送]    │
└───────┴──────────────────────────────────────────┘
  ↑ 左侧边栏（对话历史）
```

**功能说明**：
- **左侧边栏**：仅显示对话历史列表，类似`D:\CursorWork\Seth\app\chat\page.tsx`
- **顶部导航**：右上角用户名下拉菜单 → 选择档案/新建档案 → 跳转到档案管理页
- **主聊天区**：调用Dify workflow，**不进行图片识别**（节省API成本）

#### 档案管理页面（`/profile` 或 `/profile/[id]`）

```
┌──────────────────────────────────────────────────┐
│  档案管理                          [返回聊天]    │
├──────────────────────────────────────────────────┤
│                                                  │
│  我的档案列表：                                   │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐            │
│  │ 张三    │ │ 李四    │ │ + 新建  │            │
│  │ 6/2投射 │ │ 3/5生产 │ │  档案   │            │
│  └─────────┘ └─────────┘ └─────────┘            │
│                                                  │
│  ───────────────────────────────                │
│                                                  │
│  当前编辑：张三                                   │
│                                                  │
│  [上传人类图图片]  或  手动录入                   │
│                                                  │
│  ┌─────────────────────────────────────┐        │
│  │  识别到的26个闸门位置                 │        │
│  │  黑太阳：32.1   红太阳：42.3          │        │
│  │  黑地球：42.1   红地球：32.3          │        │
│  │  ...（可手动编辑修正）                │        │
│  └─────────────────────────────────────┘        │
│                                                  │
│  ┌─────────────────────────────────────┐        │
│  │  推算结果                             │        │
│  │  人生角色：1/3                        │        │
│  │  类型：生产者                         │        │
│  │  内在权威：骶骨权威                    │        │
│  │  轮回交叉：右角度交叉之...            │        │
│  │  定义：二分人                         │        │
│  │  激活通道：13-33, 20-34...           │        │
│  └─────────────────────────────────────┘        │
│                                                  │
│  [保存档案]                                      │
└──────────────────────────────────────────────────┘
```

**核心功能**：
1. 支持多档案管理（用户可为自己、家人、朋友建立多个档案）
2. 上传人类图图片 → 调用Gemini API识别26个闸门
3. 显示识别结果，允许用户手动修正
4. **实时验证逻辑**（见下文）
5. 自动推算6个核心属性
6. 保存到Supabase数据库

---

## 🧮 三、人类图识别与推算规则

### 3.1 从图片识别的26个闸门位置

**黑色（个性/意识）- 13个**：
```
黑太阳、黑地球、黑月亮、黑南交、黑北交
黑水星、黑金星、黑火星、黑木星、黑土星
黑天王星、黑海王星、黑冥王星
```

**红色（设计/潜意识）- 13个**：
```
红太阳、红地球、红月亮、红南交、红北交
红水星、红金星、红火星、红木星、红土星
红天王星、红海王星、红冥王星
```

**格式示例**：
```json
{
  "black": {
    "sun": "32.1",      // 闸门32，爻线1
    "earth": "42.1",
    "moon": "50.3",
    // ...其他11个
  },
  "red": {
    "sun": "42.3",
    "earth": "32.3",
    // ...其他11个
  }
}
```

### 3.2 验证逻辑（必须实现）

**规则1：太阳与地球闸门必须相对**
```javascript
// 示例验证逻辑
function validateSunEarth(blackSun, blackEarth, redSun, redEarth) {
  // 64个闸门的对宫关系需要从数据库或配置文件读取
  // 示例：32 ↔ 42, 1 ↔ 2, 3 ↔ 50...
  const opposites = {
    32: 42, 42: 32,
    1: 2, 2: 1,
    // ...完整64个闸门对宫表
  };

  const blackSunGate = parseInt(blackSun.split('.')[0]);
  const blackEarthGate = parseInt(blackEarth.split('.')[0]);
  const redSunGate = parseInt(redSun.split('.')[0]);
  const redEarthGate = parseInt(redEarth.split('.')[0]);

  if (opposites[blackSunGate] !== blackEarthGate) {
    return { valid: false, error: "黑太阳与黑地球闸门不相对" };
  }
  if (opposites[redSunGate] !== redEarthGate) {
    return { valid: false, error: "红太阳与红地球闸门不相对" };
  }

  return { valid: true };
}
```

**其他可能的验证规则**（待补充）：
- 月亮与南北交的逻辑关系？
- 行星位置的天文合理性？

⚠️ **如果验证失败**：提示用户检查识别结果，允许手动修正

### 3.3 推算规则（6个核心属性）

#### 属性1：人生角色（Profile）

**公式**：
```
人生角色 = 黑太阳的爻线 / 红太阳的爻线
```

**示例**：
```
黑太阳：32.1 → 爻线1
红太阳：42.3 → 爻线3
人生角色：1/3
```

**所有可能组合（12种）**：
```
1/3, 1/4, 2/4, 2/5, 3/5, 3/6
4/6, 4/1, 5/1, 5/2, 6/2, 6/3
```

---

#### 属性2：轮回交叉（Incarnation Cross）

**公式**：
```
轮回交叉 = f(黑太阳闸门, 黑地球闸门, 红太阳闸门, 红地球闸门)
```

**说明**：
- 共有192个基本轮回交叉
- 需要查表匹配
- 黑太阳闸门占75%权重，最重要

**数据来源**：
```
D:\CursorWork\download_gongzhonghao\人类图AI高我知识库\01_核心理论\人类图轮回交叉全书.txt
```

**文件格式示例**（已确认）：
```
右角度交叉之方向(人面狮身) 4——1/2/7/13
  黑太阳    黑地球    红太阳    红地球
    1         2         7         13
    1         2         8         14
    ...（每个交叉包含多个爻线组合）
```

**实现方式**：
1. 从txt文件提取192个交叉的闸门组合
2. 建立映射表：`{ "1-2-7-13": "右角度交叉之方向(人面狮身)" }`
3. 根据用户的4个闸门查表匹配

---

#### 属性3：类型（Type）

**5种类型判断逻辑**：

```javascript
function calculateType(centers, channels) {
  // centers: { sacral: true/false, throat: true/false, ... }
  // channels: ["20-34", "13-33", ...]

  const sacralDefined = centers.sacral;
  const throatDefined = centers.throat;
  const allUndefined = Object.values(centers).every(v => !v);

  // 1. 反映者（1%）
  if (allUndefined) {
    return "反映者";
  }

  // 2. 显示生产者（33%）
  if (sacralDefined && hasSacralToThroatConnection(channels)) {
    return "显示生产者";
  }

  // 3. 生产者（37%）
  if (sacralDefined) {
    return "生产者";
  }

  // 4. 显示者（8%）
  if (!sacralDefined && hasMotorToThroatConnection(centers, channels)) {
    return "显示者";
  }

  // 5. 投射者（21%）
  return "投射者";
}

// 显示生产者：骶骨到喉轮的连接
function hasSacralToThroatConnection(channels) {
  const sacralToThroatChannels = [
    "20-34", "20-57", "20-10", // 直接连接
    // 可能还有间接连接路径？需确认
  ];
  return channels.some(ch => sacralToThroatChannels.includes(ch));
}

// 显示者：动力中心到喉轮的连接
function hasMotorToThroatConnection(centers, channels) {
  // 动力中心：意志力中心、情绪中心、根部中心
  // 可以是直接通道，也可以是间接连接
  // 需要更详细的通道路径分析

  const motorToThroatChannels = [
    "21-45", "26-44", "35-36", "12-22", // 示例
    // 需要完整列表
  ];
  return channels.some(ch => motorToThroatChannels.includes(ch));
}
```

**关键问题**：
- ✅ 骶骨中心到喉轮可以是**间接连接**（用户已确认）
- ✅ 显示者的动力中心到喉轮也可以是**间接连接**
- ❓ 需要从26个闸门推算哪些中心有定义、哪些通道激活

---

#### 属性4：内在权威（Authority）

**阶梯式判断逻辑**（优先级从高到低）：

```javascript
function calculateAuthority(centers) {
  // 1. 情绪中心权威（最高优先级）
  if (centers.emotional) {
    return "情绪权威";
  }

  // 2. 骶骨中心权威
  if (centers.sacral) {
    return "骶骨权威";
  }

  // 3. 脾中心权威
  if (centers.spleen) {
    return "脾中心权威";
  }

  // 4. 自我中心权威（意志力中心）
  if (centers.ego) {
    return "自我权威";
  }

  // 5. 自我投射权威（G中心）
  if (centers.g) {
    return "自我投射权威";
  }

  // 6. 环境权威
  if (!centers.emotional && !centers.sacral && !centers.spleen && !centers.ego && !centers.g) {
    return "环境权威";
  }

  // 7. 月亮权威（反映者专用）
  const allUndefined = Object.values(centers).every(v => !v);
  if (allUndefined) {
    return "月亮权威";
  }
}
```

**9个能量中心**：
```
1. 头顶中心（Head）
2. 心智中心（Ajna）
3. 喉轮中心（Throat）
4. G中心（G/Identity）
5. 意志力中心（Ego/Heart）
6. 情绪中心（Solar Plexus）
7. 骶骨中心（Sacral）
8. 脾中心（Spleen）
9. 根部中心（Root）
```

---

#### 属性5：定义（Definition/几分人）

**判断规则**：

```javascript
function calculateDefinition(centers, channels) {
  // 1. 找出所有有定义的中心
  const definedCenters = Object.keys(centers).filter(c => centers[c]);

  // 2. 通过通道连接，将中心分组
  const groups = groupCentersByChannels(definedCenters, channels);

  // 3. 根据组数判断
  if (groups.length === 1) return "一分人";
  if (groups.length === 2) return "二分人";
  if (groups.length === 3) return "三分人";
  if (groups.length === 4) return "四分人";
}

// 伪代码：通过通道连接将中心分组
function groupCentersByChannels(definedCenters, channels) {
  // 需要实现图论算法：
  // 1. 每个中心是一个节点
  // 2. 通道是边
  // 3. 计算连通分量数量

  // 示例：如果有 [G中心, 喉轮, 骶骨] 三个有定义的中心
  // 如果存在通道连接 G-喉轮，但骶骨独立
  // 则分为2组：[G, 喉轮] 和 [骶骨] → 二分人
}
```

**4种定义**：
- 一分人（41%）：所有有定义的中心连成一个整体
- 二分人（46%）：分为两个独立区块
- 三分人（11%）：分为三个独立区块
- 四分人（0.5%）：分为四个独立区块

---

#### 属性6：激活通道（Channels）

**规则**：
- 人类图共有36条通道
- 每条通道由两个闸门组成
- 如果26个行星位置中，某两个闸门恰好配对，则该通道激活

**数据来源**：
```
D:\CursorWork\download_gongzhonghao\人类图AI高我知识库\01_核心理论\36条通道（东昍老师版）.txt
```

**需要提取**：
```
通道1：1-8（灵感的通道）
通道2：2-14（脉动的通道）
通道3：3-60（突变的通道）
...（共36条，需要从txt文件完整提取）
```

**实现逻辑**：
```javascript
function findActiveChannels(positions26) {
  const allGates = [];

  // 提取所有26个位置的闸门号
  for (let pos of positions26) {
    const gateNum = parseInt(pos.split('.')[0]);
    allGates.push(gateNum);
  }

  const activeChannels = [];

  // 遍历36条通道配对表
  for (let [gate1, gate2, channelName] of CHANNELS_36) {
    if (allGates.includes(gate1) && allGates.includes(gate2)) {
      activeChannels.push(`${gate1}-${gate2}: ${channelName}`);
    }
  }

  return activeChannels;
}
```

---

### 3.4 关键技术问题：识别策略选择

**方案A：直接从图片识别中心和通道**
- ✅ 优点：直接准确，无需复杂计算
- ❌ 缺点：Gemini识别难度大，容易出错

**方案B：从26个闸门推算中心和通道**
- ✅ 优点：识别26个文本数字容易，逻辑可控
- ❌ 缺点：需要建立闸门→中心的映射表，需要通道连接算法

**建议**：采用**方案B**（从26个闸门推算）

**原因**：
1. Gemini识别文本数字准确率高
2. 中心和通道的视觉识别不稳定（颜色、线条）
3. 推算逻辑虽然复杂，但一次开发后可复用
4. 用户可手动修正26个闸门，推算自动更新

**需要建立的映射表**：

```javascript
// 1. 64个闸门对宫表（用于验证）
const OPPOSITE_GATES = {
  1: 2, 2: 1, 3: 50, 50: 3, 4: 49, 49: 4,
  // ...完整64对
};

// 2. 闸门→中心映射表
const GATE_TO_CENTER = {
  1: "G", 2: "G", 3: "Sacral", 4: "Ajna",
  5: "Sacral", 6: "Solar Plexus", 7: "G",
  // ...完整64个闸门
};

// 3. 36条通道配对表
const CHANNELS_36 = [
  { gates: [1, 8], name: "灵感的通道", connects: ["G", "Throat"] },
  { gates: [2, 14], name: "脉动的通道", connects: ["G", "Sacral"] },
  // ...完整36条
];

// 4. 192个轮回交叉映射表
const INCARNATION_CROSSES = {
  "1-2-7-13": {
    name: "右角度交叉之方向(人面狮身)",
    type: "右角度",
    description: "..."
  },
  // ...完整192个
};
```

**数据提取任务**（后续AI需完成）：
1. 从`人类图轮回交叉全书.txt`提取192个交叉
2. 从`36条通道（东昍老师版）.txt`提取36条通道
3. 建立闸门→中心映射表（需要额外研究或资料）
4. 建立64个闸门对宫表

---

## 💬 四、Dify对话功能集成

### 4.1 Dify知识库配置

**已完成**：
- ✅ 知识库文档整理完成（200+文档）
- ✅ 上传操作手册已编写（`Dify操作手册-最终版.md`）
- ✅ 系统提示词已设计（高我人格）

**知识库内容**：
```
D:\CursorWork\download_gongzhonghao\人类图AI高我知识库\
├── 01_核心理论\
│   ├── 王骁老师文章\（171篇.md）
│   ├── 陶子文章\（21篇.md）
│   └── 补充素材（12个.txt文件）
└── 02_384爻精准库\
    └── 梁敏384爻_原始版.txt
```

**召回配置**：
```
召回模式：混合检索
TopK：6
相关度阈值：0.65
重排序：开启
```

### 4.2 主聊天功能流程

```
用户在聊天页输入消息
    ↓
前端调用Dify Workflow API
    ↓
传递参数：
  - user_name: "张三"
  - hd_type: "投射者"
  - hd_authority: "情绪权威"
  - hd_profile: "6/2"
  - hd_features: "13-33通道, 20-34通道, 情绪中心有定义"
  - user_message: "最近工作很累..."
    ↓
Dify检索知识库 + LLM生成回复
    ↓
前端显示AI高我的回应
```

**关键点**：
- 主聊天**不调用**Gemini图片识别API
- 用户档案信息从Supabase读取，传给Dify作为上下文
- 支持多轮对话，保持会话历史

### 4.3 会话变量映射

**从Supabase读取的用户档案**：
```json
{
  "user_id": "uuid-xxx",
  "profile_name": "张三",
  "hd_data": {
    "type": "投射者",
    "authority": "情绪权威",
    "profile": "6/2",
    "incarnation_cross": "右角度交叉之...",
    "definition": "二分人",
    "channels": ["13-33", "20-34"],
    "gates_26": { ... }
  }
}
```

**传递给Dify的变量**：
```javascript
{
  user_name: profile.profile_name,
  hd_type: profile.hd_data.type,
  hd_authority: profile.hd_data.authority,
  hd_profile: profile.hd_data.profile,
  hd_features: `${profile.hd_data.incarnation_cross}, ${profile.hd_data.channels.join(', ')}`
}
```

---

## 📊 五、数据库设计（Supabase）

### 5.1 表结构

**表1：users**（Supabase Auth自带）
```sql
id: uuid (主键)
email: text
created_at: timestamp
```

**表2：profiles**（用户档案）
```sql
id: uuid (主键)
user_id: uuid (外键 → users.id)
profile_name: text (档案名称，如"张三")
avatar_url: text (头像URL，可选)
created_at: timestamp
updated_at: timestamp

-- 人类图原始数据
hd_image_url: text (上传的人类图图片URL)
gates_26: jsonb (26个闸门位置)

-- 推算结果
hd_type: text (类型)
hd_authority: text (内在权威)
hd_profile: text (人生角色)
hd_incarnation_cross: text (轮回交叉)
hd_definition: text (定义)
hd_channels: text[] (激活通道数组)
hd_centers: jsonb (9个中心定义情况)

-- 其他
is_active: boolean (当前使用的档案)
```

**表3：conversations**（对话会话）
```sql
id: uuid (主键)
user_id: uuid (外键)
profile_id: uuid (外键 → profiles.id)
title: text (会话标题)
created_at: timestamp
updated_at: timestamp
```

**表4：messages**（消息记录）
```sql
id: uuid (主键)
conversation_id: uuid (外键)
role: text ('user' | 'assistant')
content: text
created_at: timestamp
```

### 5.2 权限设置（RLS）

```sql
-- 用户只能访问自己的档案
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own profiles"
  ON profiles FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own profiles"
  ON profiles FOR INSERT
  WITH CHECK (auth.uid() = user_id);

-- 类似地设置conversations和messages的RLS
```

---

## 🚀 六、开发实现步骤

### 第一阶段：基础架构（1-2天）

**任务**：
1. 初始化Next.js项目 + TypeScript + Tailwind
2. 集成Supabase（认证 + 数据库）
3. 创建基础页面路由：
   - `/` - 首页/登录页
   - `/chat` - 主聊天页
   - `/profile` - 档案管理页
4. 实现用户认证流程

**参考代码位置**：
- `D:\工作盘\三个月陪跑\陪跑打卡模板\xiaohongshulinghangyuan\app\globals.css`（样式参考）
- `D:\CursorWork\Seth\app\chat\page.tsx`（左侧边栏参考）

---

### 第二阶段：档案管理 + Gemini识别（3-4天）

**任务**：
1. 实现图片上传功能（上传到Supabase Storage）
2. 集成Gemini Vision API：
   ```javascript
   // 示例代码
   import { GoogleGenerativeAI } from "@google/generative-ai";

   const genAI = new GoogleGenerativeAI("AIzaSyD-5VGSanbUgrRRPH1R-gNXHekSdcLte3g");

   async function recognizeHumanDesignChart(imageFile) {
     const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash-exp" });

     const prompt = `
     这是一张人类图（Human Design）图片。请识别出以下26个行星位置的闸门和爻线：

     黑色（左侧）：
     - 太阳 Sun
     - 地球 Earth
     - 月亮 Moon
     - 南交 South Node
     - 北交 North Node
     - 水星 Mercury
     - 金星 Venus
     - 火星 Mars
     - 木星 Jupiter
     - 土星 Saturn
     - 天王星 Uranus
     - 海王星 Neptune
     - 冥王星 Pluto

     红色（右侧）：同上13个

     每个位置的格式为"闸门.爻线"，例如"32.1"表示32号闸门第1爻。

     请以JSON格式返回，格式如下：
     {
       "black": {
         "sun": "32.1",
         "earth": "42.1",
         ...
       },
       "red": {
         "sun": "42.3",
         "earth": "32.3",
         ...
       }
     }
     `;

     const result = await model.generateContent([
       prompt,
       {
         inlineData: {
           mimeType: imageFile.type,
           data: await fileToBase64(imageFile)
         }
       }
     ]);

     const response = result.response.text();
     return JSON.parse(response);
   }
   ```

3. 实现验证逻辑（太阳地球对宫检查）
4. 允许用户手动编辑识别结果
5. 保存到Supabase

**注意**：
- 实现API调用频率限制（15 RPM）
- 错误处理和重试机制
- 识别失败时提示用户手动录入

---

### 第三阶段：推算引擎（5-7天）

**任务**：
1. **数据准备**：
   - 从`人类图轮回交叉全书.txt`提取192个轮回交叉
   - 从`36条通道（东昍老师版）.txt`提取36条通道
   - 建立`GATE_TO_CENTER`映射表（需要研究/资料）
   - 建立`OPPOSITE_GATES`对宫表

2. **实现推算函数**：
   ```typescript
   // lib/humandesign/calculator.ts

   interface Gates26 {
     black: PlanetaryPositions;
     red: PlanetaryPositions;
   }

   interface CalculationResult {
     profile: string;              // "1/3"
     type: string;                 // "生产者"
     authority: string;            // "骶骨权威"
     incarnationCross: string;     // "右角度交叉之..."
     definition: string;           // "二分人"
     channels: string[];           // ["13-33", "20-34"]
     centers: CenterDefinitions;   // { sacral: true, throat: false, ... }
   }

   export function calculateHumanDesign(gates26: Gates26): CalculationResult {
     // 1. 推算人生角色
     const profile = calculateProfile(gates26);

     // 2. 找出激活的通道
     const channels = findActiveChannels(gates26);

     // 3. 推算中心定义
     const centers = calculateCenters(gates26, channels);

     // 4. 推算类型
     const type = calculateType(centers, channels);

     // 5. 推算内在权威
     const authority = calculateAuthority(centers);

     // 6. 推算轮回交叉
     const incarnationCross = calculateIncarnationCross(gates26);

     // 7. 推算定义
     const definition = calculateDefinition(centers, channels);

     return {
       profile,
       type,
       authority,
       incarnationCross,
       definition,
       channels,
       centers
     };
   }
   ```

3. **单元测试**：
   - 准备几个真实人类图案例
   - 验证推算结果的正确性
   - 对比现有在线工具的结果

**重点难点**：
- 闸门→中心映射表的准确性
- 通道连接的图论算法（计算定义时需要）
- 显示者/显示生产者的间接连接判断

---

### 第四阶段：Dify对话集成（2-3天）

**任务**：
1. 按照`Dify操作手册-最终版.md`完成知识库上传
2. 创建Dify workflow并获取API密钥
3. 前端集成Dify API：
   ```typescript
   // lib/dify/client.ts

   export async function sendMessageToDify(
     message: string,
     userProfile: Profile,
     conversationId?: string
   ) {
     const response = await fetch('https://api.dify.ai/v1/workflows/run', {
       method: 'POST',
       headers: {
         'Authorization': `Bearer ${process.env.NEXT_PUBLIC_DIFY_API_KEY}`,
         'Content-Type': 'application/json'
       },
       body: JSON.stringify({
         inputs: {
           user_name: userProfile.profile_name,
           hd_type: userProfile.hd_type,
           hd_authority: userProfile.hd_authority,
           hd_profile: userProfile.hd_profile,
           hd_features: `${userProfile.hd_incarnation_cross}, ${userProfile.hd_channels.join(', ')}`
         },
         query: message,
         conversation_id: conversationId,
         user: userProfile.user_id
       })
     });

     return response.json();
   }
   ```

4. 实现流式响应（打字机效果）
5. 保存对话历史到Supabase

---

### 第五阶段：UI/UX优化（2-3天）

**任务**：
1. 实现深蓝紫+金色主题
2. 毛玻璃效果、渐变文字、星空动画
3. 响应式设计（移动端适配）
4. 加载状态、错误提示、表单验证
5. 左侧对话历史列表
6. 顶部用户档案切换下拉菜单

**设计参考**：
- `D:\工作盘\三个月陪跑\陪跑打卡模板\xiaohongshulinghangyuan`

---

### 第六阶段：测试与优化（2-3天）

**任务**：
1. 完整流程测试：注册 → 上传图片 → 识别 → 推算 → 聊天
2. 边界情况测试：
   - Gemini识别失败
   - 验证逻辑不通过
   - API额度用尽
3. 性能优化：
   - 图片压缩
   - API响应缓存
   - 数据库查询优化
4. 安全检查：
   - RLS权限测试
   - API密钥保护
   - XSS/CSRF防护

---

## 📝 七、待确认/待补充的问题

### 7.1 数据提取任务

- [ ] 从`人类图轮回交叉全书.txt`完整提取192个轮回交叉（已部分读取）
- [ ] 从`36条通道（东昍老师版）.txt`提取36条通道（文件太大71254 tokens，需分段或用脚本提取）
- [ ] 建立64个闸门→中心的映射表（可能需要额外资料）
- [ ] 建立64个闸门对宫表

### 7.2 推算逻辑确认

- [ ] 显示者/显示生产者的"间接连接"具体定义？
- [ ] 计算"几分人"的图论算法实现细节
- [ ] 除了太阳地球对宫，还有其他验证规则吗？

### 7.3 产品细节

- [ ] 是否支持"合盘"功能（两个人的人类图对比）？
- [ ] 是否需要"AI解读"按钮，一键生成完整解读报告？
- [ ] 免费版vs付费版功能划分？
- [ ] 是否需要分享功能（分享自己的人类图给朋友）？

---

## 🎯 八、核心要点总结

### 关键设计决策

1. **识别策略**：从图片识别26个闸门位置（文本数字），然后推算中心、通道、类型等属性
2. **成本控制**：仅在档案录入/更新时调用Gemini API，主聊天不调用
3. **用户体验**：支持多档案管理，允许手动修正识别结果，实时验证
4. **AI人格**：高我视角，直接但温暖，融会贯通知识库内容而非机械引用

### 技术难点

1. Gemini Vision API的Prompt工程（准确识别26个闸门）
2. 推算引擎的正确性（需要完整的数据表和逻辑验证）
3. 中心连接的图论算法（计算定义时）
4. Dify对话的上下文管理（用户档案动态传递）

### 成功标准

- ✅ Gemini识别准确率 > 90%（或用户满意手动修正体验）
- ✅ 推算结果与现有人类图工具一致
- ✅ 对话体验像"高我"而非普通助手
- ✅ 系统稳定，API成本可控

---

## 📦 九、交接资料清单

**代码和文档**：
- `D:\CursorWork\HumanDesignAI\Dify操作手册-最终版.md`（Dify配置指南）
- `D:\CursorWork\HumanDesignAI\人类图推算规则总结.md`（初版规则，需修正）
- `D:\CursorWork\HumanDesignAI\项目完整需求文档.md`（本文档）

**知识库文件**：
- `D:\CursorWork\download_gongzhonghao\人类图AI高我知识库\`（200+文档）
- 关键文件：
  - `01_核心理论\人类图轮回交叉全书.txt`（192个轮回交叉）
  - `01_核心理论\36条通道（东昍老师版）.txt`（36条通道）
  - `01_核心理论\王骁老师文章\`（171篇文章）

**参考项目**：
- `D:\工作盘\三个月陪跑\陪跑打卡模板\xiaohongshulinghangyuan\`（UI设计参考）
- `D:\CursorWork\Seth\app\chat\page.tsx`（对话侧边栏参考）

**API凭证**：
- Gemini API Key: `AIzaSyD-5VGSanbUgrRRPH1R-gNXHekSdcLte3g`
- Dify API Key: 需在完成知识库上传后获取

---

## 🚀 下一步行动

**立即可做**：
1. 初始化Next.js项目
2. 提取192个轮回交叉和36条通道数据
3. 建立闸门映射表
4. 完成Dify知识库上传

**需要用户确认**：
1. 闸门→中心映射表的数据源
2. 显示者/显示生产者的间接连接具体规则
3. 产品功能范围（合盘、解读报告、付费版等）

---

---

## 🎯 十、成本分析与定价策略

### 10.1 成本估算

#### API成本（每月）

**Gemini API（免费版）**：
```
- 免费额度：1500次/天
- 约束：15 RPM（每分钟15次）
- 成本：¥0

假设：
- 100个用户，每人每月录入/更新1次档案
- 100次 × 1次/月 = 100次/月
- 远低于免费额度（1500次/天 × 30天 = 45000次/月）

结论：MVP阶段Gemini API成本为0
```

**Dify API**：
```
- Dify云服务定价：
  - 沙盒版：免费（200条消息/月）
  - 专业版：$59/月（5000条消息）
  - 团队版：$159/月（20000条消息）

假设：
- 100个用户，每人每月10次对话
- 100人 × 10次 = 1000次/月
- 需要：专业版 $59/月 ≈ ¥430/月

结论：MVP阶段Dify成本约¥500/月
```

**Supabase（数据库+存储+认证）**：
```
- 免费版：
  - 500MB数据库
  - 1GB文件存储
  - 50000 MAU（月活用户）
  - 成本：¥0

- Pro版：$25/月（约¥180/月）
  - 8GB数据库
  - 100GB存储

结论：MVP阶段Supabase成本为0
```

**总计（MVP阶段）**：
```
Gemini: ¥0
Dify: ¥500/月
Supabase: ¥0
服务器/域名: ¥100/月

总成本：约¥600/月（100用户以内）
```

---

### 10.2 定价方案（MVP版本）

**原则**：先验证付费意愿，控制成本

#### 付费订阅模式（MVP采用）

```
定价：¥99/年（约¥8.25/月）

包含功能：
- 3个档案（自己+家人/朋友）
- 无限对话
- 所有基础功能（识别、推算、AI对话）
- 对话历史永久保存

为什么必须付费：
1. API成本较高（Dify ¥500/月，100用户需覆盖成本）
2. 付费用户更认真使用，反馈质量更高
3. 验证真实付费意愿，避免无效用户

目标：
- 100个付费用户 = ¥9900/年
- 覆盖成本（¥600/月 × 12月 = ¥7200）
- 盈余用于持续优化
```

#### 定价心理设计

```
展示方式：
┌─────────────────────────────┐
│  人类图AI高我 年度订阅       │
│                             │
│  原价：¥199/年              │
│  早鸟价：¥99/年（限时）      │
│                             │
│  = 每天只需 ¥0.27           │
│  = 一杯咖啡钱陪伴你一整年    │
│                             │
│  包含：                     │
│  ✅ 3个档案管理             │
│  ✅ 无限AI对话              │
│  ✅ 人类图精准推算           │
│  ✅ 知识库深度解读           │
│                             │
│  [¥99/年 立即开通]          │
└─────────────────────────────┘

心理策略：
- 锚定效应：原价¥199 → 折扣¥99
- 分解成本：¥99/年 → ¥0.27/天
- 情感连接：一杯咖啡 → 全年陪伴
- 限时优惠：早鸟价制造紧迫感
```

#### 可选：免费试用（引流）

```
可考虑提供：
- 注册后免费3次对话体验
- 或：邀请好友各得1次免费对话

目的：
- 降低体验门槛
- 让用户感受价值后再付费
- 但避免白嫖用户过多
```

---

### 10.3 成本控制策略

1. **Gemini API优化**
   - 缓存识别结果，避免重复调用
   - 优化Prompt，减少token消耗
   - 识别失败重试限制（最多3次）

2. **Dify对话优化**
   - 设置合理的上下文窗口（避免过长历史）
   - 控制召回TopK（6条足够）
   - 避免用户恶意刷对话

3. **Supabase存储优化**
   - 图片压缩后上传
   - 定期清理未使用的文件
   - 使用CDN加速静态资源

---

### 10.4 盈利模式探索（未来）

**短期（0-6个月）**：
- 专注产品，暂不考虑盈利
- 目标：100-1000个真实用户

**中期（6-12个月）**：
- 如果用户反馈好，推出付费版
- 定价：¥99/年或¥19/月
- 目标：10%付费转化率

**长期（12个月+）**：
- 真人咨询服务（¥399-¥599/次）
- 企业版/团队版
- 线下课程导流（抽佣）

---

## 🎯 十一、MVP功能优先级

### P0（必须有）- 3-4周

**第一周：基础架构 + 支付墙**
- [ ] 用户注册/登录（Supabase Auth + 邮箱验证）
- [ ] **zpay支付集成**（必须，控制成本）
- [ ] 订阅状态管理（subscriptions表）
- [ ] 权限检查中间件（checkSubscription）
- [ ] 支付成功页面（/payment/success）

**第二周：档案管理 + 识别**
- [ ] 档案管理（创建、编辑、删除）
- [ ] 人类图图片上传（Supabase Storage）
- [ ] Gemini识别26个闸门
- [ ] 手动编辑识别结果
- [ ] 验证逻辑（太阳地球对宫）

**第三周：推算引擎 + Dify对话**
- [ ] 推算6个核心属性（人生角色、类型、权威、轮回交叉、定义、通道）
- [ ] Dify API集成
- [ ] AI对话功能（需验证订阅状态）
- [ ] 对话历史保存（conversations + messages表）

**第四周：UI优化 + 测试**
- [ ] 多档案切换
- [ ] 响应式设计（移动端适配）
- [ ] 基础UI美化（深蓝紫+金色主题）
- [ ] 完整流程测试
- [ ] 错误处理和提示

### P1（应该有）- 后续优化

- [ ] 支付页面优化（定价心理设计）
- [ ] 免费试用机制（3次对话体验）
- [ ] 邀请好友功能（双方各得1次免费对话）
- [ ] 对话体验优化（流式响应、打字机效果）
- [ ] 数据分析埋点（用户行为追踪）

### P2（可以有）- 未来迭代

- [ ] 合盘功能（两人关系解读）
- [ ] 海报生成（分享到社交媒体）
- [ ] 每日提醒（Push通知）
- [ ] 知识库内容页（64闸门、36通道详解）
- [ ] 语音对话（未来版本）

---

## 🎯 十二、用户流程设计

### 新用户完整流程

```
1. 访问网站
   ↓
2. 注册账号（邮箱+密码）
   ↓
3. 邮箱验证（点击邮件链接）
   ↓
4. 看到支付页面（无法使用功能）
   ┌─────────────────────────────┐
   │  开启你的人类图AI高我之旅    │
   │                             │
   │  ¥99/年 早鸟价              │
   │  = 每天¥0.27                │
   │                             │
   │  [立即开通]                 │
   │                             │
   │  🎁 邀请好友免费体验        │
   └─────────────────────────────┘
   ↓
5. 支付成功
   ↓
6. 创建第一个档案
   ↓
7. 上传人类图图片
   ↓
8. Gemini识别 + 手动确认
   ↓
9. 查看推算结果
   ↓
10. 开始与AI高我对话
```

### 付费验证页面设计

**未付费用户看到的页面**：
```
┌─────────────────────────────────────────┐
│  🌟 开启你的AI高我之旅                   │
├─────────────────────────────────────────┤
│                                         │
│  为了提供高质量的AI对话服务，           │
│  我们需要调用昂贵的API（Dify知识库）。   │
│                                         │
│  你的支持，让这个项目能持续运行 💫      │
│                                         │
│  ────────────────────────────────      │
│                                         │
│  年度订阅                                │
│  原价 ¥199/年                           │
│  早鸟价 ¥99/年 💥                       │
│                                         │
│  = 每天只需 ¥0.27                       │
│  = 一杯咖啡钱陪伴你一整年                │
│                                         │
│  包含：                                  │
│  ✅ 3个档案管理                         │
│  ✅ 无限AI对话                          │
│  ✅ 人类图精准推算                       │
│  ✅ 深度知识库解读                       │
│  ✅ 对话历史永久保存                     │
│                                         │
│  [¥99/年 立即开通]                      │
│                                         │
│  ────────────────────────────────      │
│                                         │
│  🎁 还没准备好？                        │
│  邀请1位好友注册，你和TA各得3次免费体验  │
│                                         │
│  [生成我的邀请链接]                      │
└─────────────────────────────────────────┘
```

---

**文档版本**：v4.0
**创建时间**：2025-01-09
**最后更新**：2025-01-09（新增zpay支付，付费订阅模式）
**负责人**：待接替AI确认

---

## 📌 重要提醒

### MVP核心策略变更

**原计划**：完全免费，快速获取用户
**现策略**：付费订阅（¥99/年），控制成本

**原因**：
1. Dify API成本高（¥500/月），免费模式不可持续
2. 付费用户更认真使用，反馈质量更高
3. 需要验证真实付费意愿，避免无效开发

**关键功能变化**：
- ✅ **第一周必须完成zpay支付集成**（原计划在P2，现提升到P0）
- ✅ 所有功能需先验证订阅状态
- ✅ 注册后立即引导支付（支付墙）
- ✅ 可选免费试用机制（邀请好友各得3次体验）

