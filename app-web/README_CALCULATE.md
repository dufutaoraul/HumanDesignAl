# 人类图计算器使用说明

## 功能概述

这个Web应用可以根据用户输入的出生信息，自动计算完整的人类图数据，包括：

- 13个行星（太阳、地球、月亮、南北交点、水星、金星、火星、木星、土星、天王星、海王星、冥王星）
- 个性端（BLACK）和设计端（RED）数据
- 每个行星的：闸门、爻线、颜色、音调、基调
- **箭头符号** (▲ Exalted / ▼ Detriment / ✲ Juxtaposed)

## 访问地址

```
http://localhost:3000/calculate
```

## 使用步骤

### 1. 输入出生信息

- **姓名**: 用户姓名
- **出生日期**: 选择出生日期（年-月-日）
- **出生时间**: 选择出生时间（时:分，24小时制）
- **出生地点**: 输入城市名称（目前支持中国主要城市）
- **时区**: 选择时区
  - 中国统一使用北京时间 (UTC+8)
  - 国外需要选择对应时区

### 2. 点击"计算人类图"

系统会自动：
1. 使用SwissEph星历表计算行星位置
2. 转换为人类图闸门/爻线数据
3. 计算设计端时间（出生前88天）
4. 应用箭头计算逻辑

### 3. 查看结果表格

显示完整的13×2数据表格：

| 行星 | 个性端 (BLACK) ||||||| 设计端 (RED) |||||||
|------|------|------|------|------|------|------|------|------|------|------|------|------|
|      | 闸门 | 爻线 | 颜色 | 音调 | 基调 | 箭头 | 闸门 | 爻线 | 颜色 | 音调 | 基调 | 箭头 |
| Sun  | 32   | 1    | 3    | 2    | 1    | ▲   | 27   | 3    | 1    | 4    | 2    |     |
| ...  | ...  | ...  | ...  | ...  | ...  | ... | ...  | ...  | ...  | ...  | ...  | ... |

### 4. 保存数据

点击"保存数据"按钮，数据会保存到浏览器本地存储。

### 5. 查看已保存数据

在页面下方可以查看所有已保存的数据，点击可以重新查看。

## 数据说明

### 闸门 (Gate)
- 范围: 1-64
- 对应人类图的64个闸门

### 爻线 (Line)
- 范围: 1-6
- 每个闸门分6条爻线

### 颜色 (Color)
- 范围: 1-6
- 每条爻线分6种颜色

### 音调 (Tone)
- 范围: 1-6
- 每种颜色分6个音调

### 基调 (Base)
- 范围: 1-5
- 每个音调分5个基调

### 箭头符号 (Arrow)
- **▲ Exalted (上升/庙旺)**: 行星处于有利位置
- **▼ Detriment (下降/失势)**: 行星处于不利位置
- **✲ Juxtaposed (并列)**: 同时具有上升和下降特质
- **(空)**: 无箭头

## 箭头计算逻辑

箭头符号通过两步计算得出：

### 步骤1: 直接规则表查询
查询固定的规则表：行星 + 闸门 + 爻线 → 箭头

### 步骤2: HarmonicGates聚合
- 查找构成通道的闸门（HarmonicGates）
- 检查其他行星是否激活了这些闸门
- 聚合这些行星的规则
- 用位或(|)合并状态

### 示例：Neptune 37.4
1. 直接查询: Neptune + Gate37 + Line4 = None
2. Gate37的HarmonicGate = Gate40
3. 查找谁激活了Gate40 → Moon在40.1
4. 聚合查询: Moon + Gate37 + Line4 = Exalted
5. 最终结果: Neptune 37.4 = ▲ Exalted

## 技术实现

### 前端
- **框架**: Next.js 14 + React + TypeScript
- **样式**: Tailwind CSS
- **组件**: 响应式表格、表单验证

### 后端API
- **路由**: `/api/calculate-chart`
- **星历计算**: SwissEph (Swiss Ephemeris)
- **箭头计算**: 自实现的JavaScript逻辑

### 星历库
- **swisseph**: 瑞士星历表，提供高精度行星位置计算
- **精度**: 约0.0001度

## 文件结构

```
app-web/
├── app/
│   ├── calculate/
│   │   └── page.tsx              # 计算器页面
│   └── api/
│       └── calculate-chart/
│           └── route.ts           # 计算API
├── lib/
│   └── calculateChart.ts          # 星历计算逻辑
├── fixing-rules-complete.js       # 箭头规则表
├── harmonic-gates.js              # 通道映射表
└── arrow-calculator.js            # 箭头计算引擎
```

## 支持的城市

目前内置以下城市坐标：

- 北京 (39.9°N, 116.4°E)
- 上海 (31.2°N, 121.5°E)
- 广州 (23.1°N, 113.3°E)
- 深圳 (22.5°N, 114.1°E)
- 成都 (30.6°N, 104.1°E)
- 杭州 (30.3°N, 120.2°E)
- 重庆 (29.4°N, 106.9°E)
- 西安 (34.3°N, 109.0°E)
- 武汉 (30.6°N, 114.3°E)
- 南京 (32.1°N, 118.8°E)

其他城市暂时使用北京坐标（后续可以集成地理编码API）。

## 时区处理

- **中国**: 统一使用北京时间 (UTC+8)
- **美国东部**: UTC-5 (冬令时) / UTC-4 (夏令时)
- **美国西部**: UTC-8 (冬令时) / UTC-7 (夏令时)
- **英国**: UTC+0 (冬令时) / UTC+1 (夏令时)
- **日本**: UTC+9

## 数据存储

- 使用浏览器LocalStorage存储
- 只在客户端保存，不上传服务器
- 数据格式: JSON
- 可以导出/导入数据

## 未来扩展

1. ✅ 基础计算功能
2. ✅ 箭头符号计算
3. ⏳ 数据库存储
4. ⏳ 用户账户系统
5. ⏳ 数据导出（PDF/图片）
6. ⏳ 高级分析功能
7. ⏳ 多语言支持

## 注意事项

⚠️ **重要**:
- 出生时间必须精确到分钟，时间误差会影响闸门/爻线的计算
- 设计端时间是自动计算的（太阳回退88度）
- 箭头符号计算已包含完整的聚合逻辑
- 数据只保存在浏览器，清除缓存会丢失

## 开发者说明

### 启动开发服务器

```bash
cd app-web
npm run dev
```

### 构建生产版本

```bash
npm run build
npm start
```

### 测试箭头计算

```bash
# 测试2017-01-20案例
node test-arrow-2017.js
```

## 参考资料

- SharpAstrology.HumanDesign: C#人类图计算库
- Swiss Ephemeris: 瑞士星历表
- 《区分的科学》: 人类图箭头符号理论
