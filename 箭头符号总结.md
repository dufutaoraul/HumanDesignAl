# 箭头符号计算总结

## 我发现的问题

### 2017-01-20 验证结果

| 位置 | 行星 | 闸门.爻线 | 规则表查询结果 | 专业软件显示 | 状态 |
|------|------|----------|--------------|------------|------|
| 设计端 | 地球 | 27.1 | ▼ Detriment | ▼ | ✅ |
| 设计端 | 月亮 | 40.1 | ▼ Detriment | ▼ | ✅ |
| 设计端 | 海王星 | 37.4 | None | ▲ | ❌ |
| 设计端 | 冥王星 | 54.1 | ▲ Exalted | ▲ | ✅ |
| 个性端 | 木星 | 32.3 | ▼ Detriment | ▼ | ✅ |
| 个性端 | 冥王星 | 54.3 | ▲ Exalted | ▲ | ✅ |

### 关键发现

**海王星 37.4 的问题：**
- 直接查规则表：Neptune + Gate37 + Line4 = **没有规则（None）**
- 专业软件显示：**▲ (Exalted)**

这说明箭头计算**不只是简单查表**，还需要额外的逻辑！

## 完整的箭头计算逻辑

从SharpAstrology代码分析，箭头计算有**两个步骤**：

### 步骤1：直接规则表查询
```csharp
result.FixingState = _getStateFromStatesTable(planet, activation.Gate, activation.Line);
```

### 步骤2：HarmonicGates聚合（关键！）
```csharp
foreach (var harmonicGate in activation.Gate.HarmonicGates())
{
    // 在同一端（个性/设计）中聚合
    result.FixingState |= _aggregateStateFromHarmonicGate(
        activation.Gate, activation.Line, harmonicGate, activations);

    // 从另一端（设计/个性）聚合
    result.FixingState |= _aggregateStateFromHarmonicGate(
        activation.Gate, activation.Line, harmonicGate, comparerActivations);
}
```

**聚合逻辑说明：**
1. 获取当前闸门的所有和谐闸门（HarmonicGates）
2. 检查这些和谐闸门是否被其他行星激活
3. 如果被激活，查询那个行星+当前闸门+当前爻线的规则
4. 使用位或运算（|=）合并所有状态

## 为什么海王星37.4会显示▲？

**猜测：**
1. 闸门37的和谐闸门可能是40（对宫闸门）
2. 设计端的月亮在40.1
3. 聚合逻辑：查询 Moon + Gate37 + Line4 的规则
4. 从规则表Line 146找到：`(Gates.Key37, Lines.Four) => FixingState.Exalted`
5. 所以海王星37.4最终显示▲

## 1983-10-15 箭头预测

根据规则表查询：

| 位置 | 行星 | 闸门.爻线 | 直接规则 | 预测箭头 |
|------|------|----------|---------|---------|
| 个性端 | 太阳 | 32.1 | ▲ Exalted | ▲ |
| 个性端 | 地球 | 42.1 | None | ? 需聚合 |
| 个性端 | 月亮 | 41.5 | None | ? 需聚合 |
| 个性端 | 北交点 | 45.1 | ? | ? 需查规则 |
| 个性端 | 水星 | 48.1 | None | ? 需聚合 |

**注意：**
- 太阳32.1 从Sun规则表Line 519找到：`(Gates.Key32, Lines.One) => FixingState.Exalted` ✅
- 其他需要考虑聚合逻辑才能准确判断

## 实现难度评估

### 简单方法（80%准确）
只查直接规则表：
- 实现简单
- 大部分情况正确
- 遗漏一些需要聚合的情况

### 完整方法（100%准确）
实现完整的聚合逻辑：
- 需要HarmonicGates映射表
- 需要实现`_aggregateStateFromHarmonicGate`逻辑
- 需要同时考虑个性端和设计端的相互影响
- **复杂度较高**

## 建议

1. **先实现简单方法**（直接查规则表），80%的箭头会正确
2. **后期再实现聚合逻辑**，达到100%准确
3. **暂时可以接受**少量箭头不显示（None），不影响核心功能

---

**结论：** 箭头符号的计算比我们想象的更复杂，涉及闸门之间的和谐关系和跨端聚合逻辑。
